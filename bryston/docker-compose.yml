services:
  # Service 1: Lyrion Music Server (formerly Logitech Media Server)
  lms:
    image: lmscommunity/lyrionmusicserver:stable
    container_name: lyrion-server
    restart: unless-stopped
    networks:
      - gw_proxy
      - lms_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lms.rule=Host(`lms.${UPSTREAM_DOMAIN:?err}`)"
      - "traefik.http.routers.lms.entrypoints=websecure"
      - "traefik.http.routers.lms.tls=true"
      - "traefik.http.routers.lms.tls.certresolver=myresolver"
      - "traefik.http.services.lms.loadbalancer.server.port=9000"
      - "traefik.docker.network=gw_proxy"
      - "traefik.http.routers.lms.middlewares=authelia@docker"
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/London
    # ports:
    #   - "9000:9000"
    #   - "3483:3483"
    #   - "3483:3483/udp"
    #   - "9090:9090"
    volumes:
      - /docker-data/lms/config:/config:rw
      - /docker-data/lms/playlist:/playlist:rw
      - /big/music:/music:ro

  # Service 2: Squeezelite (Player)
  squeezelite:
    image: giof71/squeezelite:stable
    container_name: squeezelite-bryston
    restart: unless-stopped
    networks:
      - lms_network
    privileged: true
    devices:
      - /dev/snd:/dev/snd
    environment:
      - SQUEEZELITE_NAME=Bryston_BDA2
      - SQUEEZELITE_AUDIO_DEVICE=hw:CARD=B20,DEV=0
      - SQUEEZELITE_SERVER_PORT=lms:3483
      - SQUEEZELITE_RATES=44100,48000,88200,96000,176400,192000
      - SQUEEZELITE_CODECS=flac,pcm
      # ALSA PARAMS for Audiophile Quality
      # 80ms buffer, 4 periods, 32-bit format (Bryston supports 32-bit via USB)
      # - SQUEEZELITE_ALSA_PARAMS=80:4:32:1
      - SQUEEZELITE_BUFFER_SIZE=20000:50000
      - SQUEEZELITE_MIXER_DEVICE=null
      - SQUEEZELITE_PARAMS=-X
      - SQUEEZELITE_MAC_ADDRESS=02:00:00:00:00:01

      # OPTIONAL: Exclude codecs to force LMS to decode (lowers CPU on player)
      # - SQUEEZELITE_EXCLUDE_CODECS=

networks:
  gw_proxy:
    external: true
  lms_network: